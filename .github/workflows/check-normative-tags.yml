name: Check Normative Tag Changes

on:
  push:
    paths:
      - 'src/**'
      - 'normative_rule_defs/**'
      - 'ref/**'
      - 'scripts/check-tag-changes.sh'
  pull_request:
    paths:
      - 'src/**'
      - 'normative_rule_defs/**'
      - 'ref/**'
      - 'scripts/check-tag-changes.sh'
  workflow_dispatch:  # Allows manual testing from GitHub UI

jobs:
  check-tags:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Check for bypass label
        id: bypass
        if: github.event_name == 'pull_request'
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | grep -q "normative-change-approved"; then
            echo "has_bypass=true" >> $GITHUB_OUTPUT
            echo "::notice::Bypass label 'normative-change-approved' found - check will report but not fail"
          else
            echo "has_bypass=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build normative tags
        run: make build-tags

      - name: Check for tag changes
        id: check
        continue-on-error: true
        run: |
          set +e  # Don't exit on error, we want to capture the output

          echo "## Normative Tag Change Report" > tag_changes.txt
          echo "" >> tag_changes.txt

          echo "### Unprivileged Specification" >> tag_changes.txt
          echo "" >> tag_changes.txt
          echo '```' >> tag_changes.txt
          ruby docs-resources/tools/detect_tag_changes.rb \
            --verbose \
            ref/riscv-unprivileged-norm-tags.json \
            build/riscv-unprivileged-norm-tags.json 2>&1 | tee -a tag_changes.txt
          UNPRIV_EXIT=${PIPESTATUS[0]}
          echo '```' >> tag_changes.txt
          echo "" >> tag_changes.txt

          echo "### Privileged Specification" >> tag_changes.txt
          echo "" >> tag_changes.txt
          echo '```' >> tag_changes.txt
          ruby docs-resources/tools/detect_tag_changes.rb \
            --verbose \
            ref/riscv-privileged-norm-tags.json \
            build/riscv-privileged-norm-tags.json 2>&1 | tee -a tag_changes.txt
          PRIV_EXIT=${PIPESTATUS[0]}
          echo '```' >> tag_changes.txt

          # Save output for later steps
          echo "TAG_CHANGES<<EOF" >> $GITHUB_ENV
          cat tag_changes.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Exit with failure if either check failed (modifications or deletions detected)
          if [ $UNPRIV_EXIT -ne 0 ] || [ $PRIV_EXIT -ne 0 ]; then
            echo "has_breaking_changes=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Update reference files (on push to main only)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          # Update reference files with any new tags
          ruby docs-resources/tools/detect_tag_changes.rb \
            --update-reference \
            ref/riscv-unprivileged-norm-tags.json \
            build/riscv-unprivileged-norm-tags.json

          ruby docs-resources/tools/detect_tag_changes.rb \
            --update-reference \
            ref/riscv-privileged-norm-tags.json \
            build/riscv-privileged-norm-tags.json

      - name: Commit updated reference files
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ref/*.json
          git diff --staged --quiet || git commit -m "Auto-update normative tag reference files"
          git push

      - name: Comment on PR with detected changes
        if: steps.check.outcome == 'failure' && github.event_name == 'pull_request' && steps.bypass.outputs.has_bypass != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/comment-pr-changes.js');
            const tagChanges = process.env.TAG_CHANGES;
            await script({github, context, tagChanges});

      - name: Create issue on merge to main
        if: steps.check.outcome == 'failure' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/create-tag-change-issue.js');
            const tagChanges = process.env.TAG_CHANGES;
            await script({github, context, tagChanges});

      - name: Report changes (bypass mode)
        if: steps.check.outcome == 'failure' && github.event_name == 'pull_request' && steps.bypass.outputs.has_bypass == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/comment-bypass-mode.js');
            const tagChanges = process.env.TAG_CHANGES;
            await script({github, context, tagChanges});

      - name: Report normative changes detected
        if: steps.check.outcome == 'failure'
        run: |
          echo "::warning::Normative tag changes detected - modifications or deletions found. An issue has been created for tracking."
          echo "::notice::Review the created issue and PR comments for details."
