name: Check Normative Tag Changes

on:
  push:
    paths:
      - 'src/**'
      - 'normative_rule_defs/**'
      - 'ref/**'
      - 'scripts/check-tag-changes.sh'
  pull_request:
    paths:
      - 'src/**'
      - 'normative_rule_defs/**'
      - 'ref/**'
      - 'scripts/check-tag-changes.sh'
  workflow_dispatch:  # Allows manual testing from GitHub UI

env:
  # Branches that trigger issue creation on push/merge
  # Add or remove branches as needed (comma-separated)
  ISSUE_TRIGGER_BRANCHES: 'main,ci-dev'

jobs:
  check-tags:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: write
      pull-requests: write

    steps:
      - name: Check for bypass label
        id: bypass
        if: github.event_name == 'pull_request'
        run: |
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          if echo "$LABELS" | grep -q "normative-change-approved"; then
            echo "has_bypass=true" >> $GITHUB_OUTPUT
            echo "::notice::Bypass label 'normative-change-approved' found - check will report but not fail"
          else
            echo "has_bypass=false" >> $GITHUB_OUTPUT
          fi

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build normative tags
        run: make build-tags

      - name: Check for tag changes
        id: check
        continue-on-error: true
        run: |
          set +e  # Don't exit on error, we want to capture the output

          echo "## Normative Tag Change Report" > tag_changes.txt
          echo "" >> tag_changes.txt

          echo "### Unprivileged Specification" >> tag_changes.txt
          echo "" >> tag_changes.txt
          echo '```' >> tag_changes.txt
          UNPRIV_OUTPUT=$(ruby docs-resources/tools/detect_tag_changes.rb \
            --verbose \
            ref/riscv-unprivileged-norm-tags.json \
            build/riscv-unprivileged-norm-tags.json 2>&1)
          UNPRIV_EXIT=$?
          echo "$UNPRIV_OUTPUT" | tee -a tag_changes.txt
          echo '```' >> tag_changes.txt
          echo "" >> tag_changes.txt

          echo "### Privileged Specification" >> tag_changes.txt
          echo "" >> tag_changes.txt
          echo '```' >> tag_changes.txt
          PRIV_OUTPUT=$(ruby docs-resources/tools/detect_tag_changes.rb \
            --verbose \
            ref/riscv-privileged-norm-tags.json \
            build/riscv-privileged-norm-tags.json 2>&1)
          PRIV_EXIT=$?
          echo "$PRIV_OUTPUT" | tee -a tag_changes.txt
          echo '```' >> tag_changes.txt

          # Save output for later steps
          echo "TAG_CHANGES<<EOF" >> $GITHUB_ENV
          cat tag_changes.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          # Check if ANY changes were detected (additions, modifications, or deletions)
          HAS_CHANGES=false
          if echo "$UNPRIV_OUTPUT" | grep -qE "(Added|Modified|Deleted) [0-9]+ tag"; then
            HAS_CHANGES=true
          fi
          if echo "$PRIV_OUTPUT" | grep -qE "(Added|Modified|Deleted) [0-9]+ tag"; then
            HAS_CHANGES=true
          fi

          echo "has_any_changes=$HAS_CHANGES" >> $GITHUB_OUTPUT

          # Exit with failure only if modifications or deletions detected (breaking changes)
          if [ $UNPRIV_EXIT -ne 0 ] || [ $PRIV_EXIT -ne 0 ]; then
            echo "has_breaking_changes=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "has_breaking_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

      - name: Check if branch triggers issues
        id: branch-check
        if: github.event_name == 'push'
        run: |
          CURRENT_BRANCH="${GITHUB_REF#refs/heads/}"
          echo "Current branch: $CURRENT_BRANCH"
          if echo "${{ env.ISSUE_TRIGGER_BRANCHES }}" | grep -qE "(^|,)${CURRENT_BRANCH}(,|$)"; then
            echo "is_trigger_branch=true" >> $GITHUB_OUTPUT
            echo "Branch '$CURRENT_BRANCH' is configured to trigger issues"
          else
            echo "is_trigger_branch=false" >> $GITHUB_OUTPUT
            echo "Branch '$CURRENT_BRANCH' is not configured to trigger issues"
          fi

      - name: Update reference files (on configured branches only)
        if: github.event_name == 'push' && steps.branch-check.outputs.is_trigger_branch == 'true'
        run: |
          # Update reference files with any new tags
          ruby docs-resources/tools/detect_tag_changes.rb \
            --update-reference \
            ref/riscv-unprivileged-norm-tags.json \
            build/riscv-unprivileged-norm-tags.json

          ruby docs-resources/tools/detect_tag_changes.rb \
            --update-reference \
            ref/riscv-privileged-norm-tags.json \
            build/riscv-privileged-norm-tags.json

      - name: Commit updated reference files
        if: github.event_name == 'push' && steps.branch-check.outputs.is_trigger_branch == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add ref/*.json
          git diff --staged --quiet || git commit -m "Auto-update normative tag reference files"
          git push

      - name: Comment on PR with detected changes
        if: steps.check.outputs.has_any_changes == 'true' && github.event_name == 'pull_request' && steps.bypass.outputs.has_bypass != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/comment-pr-changes.js');
            const tagChanges = process.env.TAG_CHANGES;
            await script({github, context, tagChanges});

      - name: Create issue on merge to configured branches
        if: steps.check.outputs.has_any_changes == 'true' && github.event_name == 'push' && steps.branch-check.outputs.is_trigger_branch == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/create-tag-change-issue.js');
            const tagChanges = process.env.TAG_CHANGES;
            await script({github, context, tagChanges});

      - name: Report changes (bypass mode)
        if: steps.check.outputs.has_any_changes == 'true' && github.event_name == 'pull_request' && steps.bypass.outputs.has_bypass == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const script = require('./.github/scripts/comment-bypass-mode.js');
            const tagChanges = process.env.TAG_CHANGES;
            await script({github, context, tagChanges});

      - name: Report normative changes detected
        if: steps.check.outputs.has_any_changes == 'true'
        run: |
          echo "::warning::Normative tag changes detected (additions, modifications, or deletions)."
          echo "::notice::Review the PR comments or created issue for details."
